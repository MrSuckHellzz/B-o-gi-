<%- include('partials/header') %>
<main>
    <a href="/category" class="category-return"><p>&#8592; Quay v·ªÅ trang Nh√≥m H√†ng</p></a>
    <h1 class="main-title text-center m-3 color"><strong>T√™n nh√≥m h√†ng ƒë∆∞·ª£c ch·ªçn</strong></h1>

    <div class="product-form-container">
        <input class="search-app-input" type="search" id="liveSearch" placeholder="T√¨m ki·∫øm m·∫∑t h√†ng..." aria-label="T√¨m Ki·∫øm">
        <h3 id="form-product-button">&#x2795; Th√™m h√†ng</h3>
    </div>
    <form id="product-form" method="POST" action="/product/<%= categoryId %>">
        <label for="productName" class="form-label me-2">T√™n m·∫∑t h√†ng (quy c√°ch):</label>
        <input type="text" class="form-control me-2 border-black" id="productName" name="productName" required>
        <label for="productWeight" class="form-label me-2">Tr·ªçng l∆∞·ª£ng:</label>
        <input type="text" class="form-control me-2 border-black" id="productWeight" name="productWeight">
        <label for="productLength" class="form-label me-2">ƒê·ªô d√†i:</label>
        <input type="text" class="form-control me-2 border-black" id="productLength" name="productLength">
        <label for="productWidth" class="form-label me-2">ƒê·ªô r·ªông:</label>
        <input type="text" class="form-control me-2 border-black" id="productWidth" name="productWidth">
        <label for="productThick" class="form-label me-2">ƒê·ªô d√†y:</label>
        <input type="text" class="form-control me-2 border-black" id="productThick" name="productThick">
        <label for="priceIn" class="form-label me-2">Gi√° nh·∫≠p:</label>
        <input type="text" class="form-control me-2 border-black" id="priceIn" name="priceIn">
        <label for="priceOut" class="form-label me-2">Gi√° b√°n:</label>
        <input type="text" class="form-control me-2 border-black" id="priceOut" name="priceOut">
        <label for="pricePer" class="form-label me-2">ƒê∆°n gi√°:</label>
        <input type="text" class="form-control me-2 border-black" id="pricePer" name="pricePer">
        <button type="submit" class="submit-button full-width">Th√™m</button>
    </form>

    <hr>

    <!--No result message-->
    <div id="no-results">
        Kh√¥ng t√¨m th·∫•y nh√≥m h√†ng n√†o ph√π h·ª£p v·ªõi "<span id="search-term"></span>"
    </div>
    
    <div class="category-products">
        <table class="product-table">
            <thead>
                <tr>
                    <td>T√™n h√†ng (quy c√°ch)</td>
                    <td>Tr·ªçng l∆∞·ª£ng</td>
                    <td>ƒê·ªô d√†i</td>
                    <td>ƒê·ªô r·ªông</td>
                    <td>ƒê·ªô d√†y</td>
                    <td>Gi√° nh·∫≠p</td>
                    <td>Gi√° b√°n</td>
                    <td>ƒê∆°n gi√°</td>
                    <td style="
                        background-color: rgb(255, 0, 0); 
                        color: rgb(255, 255, 255);
                        ">
                    X√≥a
                    </td>
                    <td style="
                        background-color: rgb(1, 1, 169);
                        color: white;
                        ">
                    Ch·ªânh S·ª≠a
                    </td>
                </tr>
            </thead>
            <tbody>
                <% products.forEach(product => {%>
                    <tr class="product-row" data-name="<%= product.name.toLowerCase() %>">
                        <td><%= product.name %></td>
                        <td><%= product.weight %></td>
                        <td><%= product.length %></td>
                        <td><%= product.width %></td>
                        <td><%= product.thickness %></td>
                        <td><%= product.priceIn %></td>
                        <td><%= product.priceOut %></td>
                        <td><%= product.pricePer %></td>
                        <td class="product-remove">
                            <form method = "POST" action="/product/delete/<%= categoryId %>/<%= product._id %>" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·∫∑t h√†ng n√†y kh√¥ng?');">
                                <button type="submit" class="product-delete-button">üóëÔ∏è</button>
                            </form>
                        </td>
                        <td class ="product-edit">
                            <button class="product-edit-button" data-bs-target="#product-fixing-<%= product._id %>" data-bs-toggle="modal" data-bs-dismiss="modal">‚úèÔ∏è</button> 
                            <div id="product-fixing-<%= product._id %>" class="modal fade" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Ch·ªânh s·ª≠a m·∫∑t h√†ng</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="POST" action="/product/update/<%= categoryId %>/<%= product._id %>">
                                                <div class="mb-3">
                                                    <label for="productName" class="form-label">T√™n m·∫∑t h√†ng (quy c√°ch):</label>
                                                    <input type="text" class="form-control border-black" id="productName" name="productName" value="<%= product.name %>" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="productWeight" class="form-label">Tr·ªçng l∆∞·ª£ng:</label>
                                                    <input type="text" class="form-control border-black" id="productWeight" name="productWeight" value="<%= product.weight %>">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="productLength" class="form-label">ƒê·ªô d√†i:</label>
                                                    <input type="text" class="form-control border-black" id="productLength" name="productLength" value="<%= product.length %>">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="productWidth" class="form-label">ƒê·ªô r·ªông:</label>
                                                    <input type="text" class="form-control border-black" id="productWidth" name="productWidth" value="<%= product.width %>">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="productThick" class="form-label">ƒê·ªô d√†y:</label>
                                                    <input type="text" class="form-control border-black" id="productThick" name="productThick" value="<%= product.thickness %>">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="priceIn" class="form-label">Gi√° nh·∫≠p:</label>
                                                    <input type="text" class="form-control border-black" id="priceIn" name="priceIn" value="<%= product.priceIn %>">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="priceOut" class="form-label">Gi√° b√°n:</label>
                                                    <input type="text" class="form-control border-black" id="priceOut" name="priceOut" value="<%= product.priceOut %>">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="pricePer" class="form-label">ƒê∆°n gi√°:</label>
                                                    <input type="text" class="form-control border-black" id="pricePer" name="pricePer" value="<%= product.pricePer %>">
                                                </div>
                                                <button type="submit" class="submit-button full-width">L∆∞u thay ƒë·ªïi</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
</main>

<script>
    //Toggle product form visibility
    let productButton = document.getElementById('form-product-button');
    let productForm = document.getElementById('product-form');
    
    productButton.addEventListener('click', () => {
        if (productForm.classList.contains('visible') === false) {
            productForm.classList.toggle('visible');
            productButton.innerHTML ="&#x2796; ·∫®n bi·ªÉu m·∫´u";
        } else {
            productForm.classList.toggle('visible');
            productButton.innerHTML ="&#x2795; Th√™m m·∫∑t h√†ng";
        }
    });

    // LIVE SEARCH FUNCTIONALITY
    const searchInput = document.getElementById('liveSearch');
    const noResults = document.getElementById('no-results');
    const searchTerm = document.getElementById('search-term');

    // Function to remove Vietnamese accents/diacritics
    function removeVietnameseAccents(text) {
        const vietnameseMap = {
            '√†': 'a', '√°': 'a', '·∫°': 'a', '·∫£': 'a', '√£': 'a',
            '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫≠': 'a', '·∫©': 'a', '·∫´': 'a',
            'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫∑': 'a', '·∫≥': 'a', '·∫µ': 'a',
            '√®': 'e', '√©': 'e', '·∫π': 'e', '·∫ª': 'e', '·∫Ω': 'e',
            '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªá': 'e', '·ªÉ': 'e', '·ªÖ': 'e',
            '√¨': 'i', '√≠': 'i', '·ªã': 'i', '·ªâ': 'i', 'ƒ©': 'i',
            '√≤': 'o', '√≥': 'o', '·ªç': 'o', '·ªè': 'o', '√µ': 'o',
            '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªô': 'o', '·ªï': 'o', '·ªó': 'o',
            '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ª£': 'o', '·ªü': 'o', '·ª°': 'o',
            '√π': 'u', '√∫': 'u', '·ª•': 'u', '·ªß': 'u', '≈©': 'u',
            '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª±': 'u', '·ª≠': 'u', '·ªØ': 'u',
            '·ª≥': 'y', '√Ω': 'y', '·ªµ': 'y', '·ª∑': 'y', '·ªπ': 'y',
            'ƒë': 'd', 'ƒê': 'D'
        };
        
        return text.toLowerCase().replace(/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒëƒê]/g, 
            function(match) {
                return vietnameseMap[match] || match;
            });
    }
    
    // Function to check if search terms match (accent-insensitive)
    function matchesSearch(productName, searchQuery) {
        // Remove accents from both strings
        const normalizedName = removeVietnameseAccents(productName);
        const normalizedQuery = removeVietnameseAccents(searchQuery.trim());
        
        if (normalizedQuery === '') return true; // Show all if no search
        
        // Split search query into individual words
        const searchWords = normalizedQuery.split(/\s+/);
        
        // Check if ALL search words are found in the category name
        return searchWords.every(word => normalizedName.includes(word));
    }

    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        const productRows = document.querySelectorAll('.product-row');
        let visibleCount = 0;

        productRows.forEach(row => {
            const name = row.getAttribute('data-name');
            
            // Check if query matches name or description
            if (matchesSearch(name, query)) {
                row.style.display= 'table-row';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Show/hide "no results" message
        if (query === '') {
            noResults.style.display = 'none';
        } else if (visibleCount === 0) {
            noResults.style.display = 'block';
            searchTerm.textContent = query;
        } else {
            noResults.style.display = 'none';
        }
    });
</script>
<%- include('partials/footer') %>